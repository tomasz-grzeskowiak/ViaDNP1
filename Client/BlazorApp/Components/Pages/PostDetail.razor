@page "/post/{PostId:int}"
@using System.Security.Claims
@using ApiContracts.DTOs
@using BlazorApp.Services
@inject IPostService PostService
@inject ICommentService CommentService
@attribute [Authorize]
<h3>Post Details</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (postWithComments == null)
{
    <p>Loading...</p>
}
else
{
    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <h4>@postWithComments.Post.Title</h4>
            <h6 class="text-muted">by @postWithComments.Post.Username</h6>
            <p>@postWithComments.Post.Body</p>
        </div>
    </div>

    <h5>Comments</h5>
    @if (postWithComments.Comments.Any())
    {
        <ul class="list-group mb-3">
            @foreach (var comment in postWithComments.Comments)
            {
                <li class="list-group-item">
                    <strong>@comment.Username:</strong> @comment.Body
                </li>
            }
        </ul>
    }
    else
    {
        <p>No comments yet.</p>
    }

    <div class="mb-3">
        <textarea class="form-control" @bind="newCommentBody" placeholder="Add a comment..."></textarea>
        <button class="btn btn-primary mt-2" @onclick="AddCommentAsync">Post Comment</button>
    </div>
}

@code {
    [Parameter] public int PostId { get; set; }
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    private PostWithCommentsDto? postWithComments;
    private string newCommentBody = "";
    private string errorMessage = "";
    private int userId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            postWithComments = await PostService.GetPostAsync(PostId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load post: {ex.Message}";
        }
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal claimsPrincipal = authenticationState.User;

        if (claimsPrincipal.Identity == null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            return; // user not logged in
        }
        var idClaim = claimsPrincipal.Claims
            .FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier);
        if (idClaim == null)
        {
            errorMessage = "User ID not found in claims.";
            return;
        }
        userId = int.Parse(idClaim.Value); 
    }

    private async Task AddCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(newCommentBody)) return;

        try
        {
            var comment = await CommentService.AddCommentAsync(new CreateCommentDto(PostId, newCommentBody, userId));
            postWithComments!.Comments.Add(comment);
            newCommentBody = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to add comment: {ex.Message}";
        }
    }

}
